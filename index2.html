<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Boxcel Ê≠©Ë°å„Éá„É¢Ôºà„É≠„Ç∞Ë°®Á§∫‰ªò„ÅçÔºâ</title>
  <style>
    body { margin:0; overflow:hidden; }
    canvas { display:block; }
    #ui { position:absolute; top:10px; left:10px; z-index:10; }
    #ui button { margin:2px; }
    #log { position:absolute; bottom:0; left:0; width:100%; max-height:150px; 
           background:rgba(0,0,0,0.6); color:#0f0; font-size:12px; overflow-y:auto; 
           font-family:monospace; padding:4px; box-sizing:border-box; }
  </style>
</head>
<body>
  <div id="ui">
    <button id="switch">ÂàáÊõø 2D/3D</button>
  </div>
  <div id="log"></div>
  <canvas id="gameCanvas"></canvas>

  <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js';

    const canvas = document.getElementById('gameCanvas');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // üîπ ÁîªÈù¢‰∏ä„É≠„Ç∞Èñ¢Êï∞
    const logDiv = document.getElementById('log');
    function log(msg){
      logDiv.innerText += msg + "\n";
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    log('„Éá„É¢ÈñãÂßã');

    let mode = '2D';
    const scene = new THREE.Scene();

    const modelHeight = 50;
    const camera2D = new THREE.OrthographicCamera(-modelHeight*2, modelHeight*2, modelHeight*2, -modelHeight*2, 0.1, 1000);
    const camera3D = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({canvas, alpha:true});
    renderer.setSize(window.innerWidth, window.innerHeight);

    // üîπ „Éï„Ç£„Éº„É´„Éâ
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(1000,200), new THREE.MeshBasicMaterial({color:0x88cc88}));
    ground.rotation.x = -Math.PI/2;
    scene.add(ground);

    // üîπ Boxcel„É¢„Éá„É´
    const boxcelModel = new THREE.Group();
    const clothes = new THREE.Mesh(new THREE.BoxGeometry(20,30,10), new THREE.MeshBasicMaterial({color:0x0000ff}));
    clothes.position.y = 40;
    const hair = new THREE.Mesh(new THREE.BoxGeometry(20,10,20), new THREE.MeshBasicMaterial({color:0xff0000}));
    hair.position.y = 60;
    const leftArm = new THREE.Mesh(new THREE.BoxGeometry(5,20,5), new THREE.MeshBasicMaterial({color:0xffaaaa}));
    leftArm.position.set(-12,45,0);
    const rightArm = new THREE.Mesh(new THREE.BoxGeometry(5,20,5), new THREE.MeshBasicMaterial({color:0xffaaaa}));
    rightArm.position.set(12,45,0);
    const leftLeg = new THREE.Mesh(new THREE.BoxGeometry(5,18,5), new THREE.MeshBasicMaterial({color:0xaaaaff}));
    leftLeg.position.set(-7, 18, 0);
    const rightLeg = new THREE.Mesh(new THREE.BoxGeometry(5,18,5), new THREE.MeshBasicMaterial({color:0xaaaaff}));
    rightLeg.position.set(7, 18, 0);
    boxcelModel.add(clothes, hair, leftArm, rightArm, leftLeg, rightLeg);
    boxcelModel.scale.set(1,1,0.5);
    scene.add(boxcelModel);

    // üîπ „Éó„É¨„Ç§„É§„ÉºÁßªÂãï
    const playerSpeed = 2;
    const keys = {};
    window.addEventListener('keydown', e => keys[e.key] = true);
    window.addEventListener('keyup', e => keys[e.key] = false);

    // üîπ Ê≠©Ë°å„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
    let walkCycle = 0;
    function updateWalkAnimation(isMoving){
      if(isMoving){
        walkCycle += 0.2;
        const swing = Math.sin(walkCycle) * 0.6;
        leftArm.rotation.x = swing;
        rightArm.rotation.x = -swing;
        leftLeg.rotation.x = -swing;
        rightLeg.rotation.x = swing;
        log(`Ê≠©Ë°å„Çµ„Ç§„ÇØ„É´: ${walkCycle.toFixed(2)}`);
      } else {
        leftArm.rotation.x = rightArm.rotation.x = 0;
        leftLeg.rotation.x = rightLeg.rotation.x = 0;
        walkCycle = 0;
      }
    }

    // üîπ „Ç´„É°„É©Êõ¥Êñ∞
    function update2DCamera(){
      const offset = new THREE.Vector3(0,50,100);
      camera2D.position.copy(boxcelModel.position.clone().add(offset));
      camera2D.lookAt(boxcelModel.position.x,0,0);
    }
    function update3DCamera(){
      const offset = new THREE.Vector3(0,120,100);
      camera3D.position.copy(boxcelModel.position.clone().add(offset));
      camera3D.lookAt(boxcelModel.position);
    }

    // üîπ „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„É´„Éº„Éó
    function animate(){
      requestAnimationFrame(animate);
      let moving = false;
      if(keys['ArrowRight']) { boxcelModel.position.x += playerSpeed; moving = true; log('Âè≥ÁßªÂãï'); }
      if(keys['ArrowLeft']) { boxcelModel.position.x -= playerSpeed; moving = true; log('Â∑¶ÁßªÂãï'); }

      if(mode==='3D') boxcelModel.rotation.y += 0.01;

      updateWalkAnimation(moving);

      if(mode==='2D') update2DCamera();
      else update3DCamera();

      renderer.render(scene, mode==='2D'?camera2D:camera3D);
    }
    animate();

    // UIÊìç‰Ωú
    document.getElementById('switch').addEventListener('click', ()=>{
      mode = mode==='2D'?'3D':'2D';
      if(mode==='2D') boxcelModel.rotation.y = 0;
      log(`„É¢„Éº„ÉâÂàáÊõø: ${mode}`);
    });

    // „É™„Çµ„Ç§„Ç∫ÂØæÂøú
    window.addEventListener('resize',()=>{
      renderer.setSize(window.innerWidth, window.innerHeight);
      camera2D.left = -modelHeight*2;
      camera2D.right = modelHeight*2;
      camera2D.top = modelHeight*2;
      camera2D.bottom = -modelHeight*2;
      camera2D.updateProjectionMatrix();
      camera3D.aspect = window.innerWidth/window.innerHeight;
      camera3D.updateProjectionMatrix();
      log('ÁîªÈù¢„É™„Çµ„Ç§„Ç∫');
    });
  </script>
</body>
</html>
